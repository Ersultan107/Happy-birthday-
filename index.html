<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Birthday Magic</title>
    <style>
        :root {
            --cake-color: #f4dcd6;
            --cream-color: #ffffff;
            --accent: #d4a373;
        }

        body {
            background: radial-gradient(circle at center, #2c2c2c 0%, #111111 100%);
            margin: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            font-family: 'Playfair Display', serif;
            overflow: hidden;
            perspective: 1000px;
        }

        /* Эффект старой кинопленки */
        .film-grain {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://upload.wikimedia.org/wikipedia/commons/7/76/1k_Grain.jpg');
            opacity: 0.05;
            pointer-events: none;
            z-index: 100;
            animation: grain 0.5s steps(10) infinite;
        }

        @keyframes grain {
            0%, 100% { transform: translate(0, 0); }
            10% { transform: translate(-1%, -1%); }
            30% { transform: translate(1%, 1%); }
            50% { transform: translate(-0.5%, 0.5%); }
        }

        /* Контейнер торта */
        .cake-stage {
            position: relative;
            width: 250px;
            height: 300px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            display: none; /* Появится после клика */
        }

        /* Анимация слоев */
        .layer {
            width: 200px;
            height: 40px;
            background: var(--cake-color);
            border-radius: 10px;
            box-shadow: inset 0 -5px 10px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(20px);
        }

        .cream {
            width: 210px;
            height: 15px;
            background: var(--cream-color);
            border-radius: 20px;
            margin-top: -5px;
            z-index: 2;
            clip-path: inset(0 100% 0 0); /* Эффект намазывания */
        }

        /* Анимации появления */
        .animate-layer { animation: layerUp 1s ease forwards; }
        .animate-cream { animation: spreadCream 1.5s ease forwards; }

        @keyframes layerUp {
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spreadCream {
            to { clip-path: inset(0 0 0 0); }
        }

        /* Свеча и огонь */
        .candle {
            width: 6px; height: 40px;
            background: linear-gradient(to bottom, #eee, var(--accent));
            margin-bottom: 2px;
            opacity: 0;
            position: relative;
        }

        .flame {
            width: 14px; height: 22px;
            background: radial-gradient(circle at bottom, #fff 0%, #fbd38d 40%, #f6ad55 70%, transparent 100%);
            border-radius: 50% 50% 20% 20%;
            position: absolute; top: -25px; left: -4px;
            filter: blur(0.5px);
            box-shadow: 0 0 20px #f6ad55;
            animation: flicker 0.1s infinite alternate;
        }

        @keyframes flicker {
            0% { transform: scale(1) rotate(-2deg); }
            100% { transform: scale(1.1) rotate(2deg); }
        }

        /* Кнопка */
        #start-btn {
            z-index: 150;
            padding: 20px 50px;
            background: none;
            border: 1px solid var(--accent);
            color: var(--accent);
            font-size: 1.2rem;
            letter-spacing: 5px;
            cursor: pointer;
            transition: 0.5s;
            text-transform: uppercase;
        }

        #start-btn:hover { background: var(--accent); color: white; }

        .hint {
            position: absolute; bottom: -60px;
            font-style: italic; opacity: 0; transition: 1s;
            color: var(--accent); width: 300px; text-align: center;
        }
    </style>
</head>
<body>

    <div class="film-grain"></div>
    <button id="start-btn">Открыть подарок</button>

    <div class="cake-stage" id="stage">
        <div class="candle" id="candle"><div class="flame" id="flame"></div></div>
        <div class="layer" id="l3"></div>
        <div class="cream" id="c2"></div>
        <div class="layer" id="l2"></div>
        <div class="cream" id="c1"></div>
        <div class="layer" id="l1"></div>
        <div class="hint" id="hint">Загадай желание и дуй на свечу...</div>
    </div>

    <script>
        const btn = document.getElementById('start-btn');
        const stage = document.getElementById('stage');
        const hint = document.getElementById('hint');
        const flame = document.getElementById('flame');

        btn.onclick = () => {
            btn.style.display = 'none';
            stage.style.display = 'flex';
            buildCake();
        };

        function buildCake() {
            const parts = [
                {id: 'l1', type: 'layer', delay: 500},
                {id: 'c1', type: 'cream', delay: 1500},
                {id: 'l2', type: 'layer', delay: 2500},
                {id: 'c2', type: 'cream', delay: 3500},
                {id: 'l3', type: 'layer', delay: 4500}
            ];

            parts.forEach(p => {
                setTimeout(() => {
                    document.getElementById(p.id).classList.add(p.type === 'layer' ? 'animate-layer' : 'animate-cream');
                }, p.delay);
            });

            setTimeout(() => {
                document.getElementById('candle').style.opacity = '1';
                hint.style.opacity = '1';
                initMic();
            }, 6000);
        }

        async function initMic() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const source = audioContext.createMediaStreamSource(stream);
                source.connect(analyser);
                
                const dataArray = new Uint8Array(analyser.frequencyBinCount);

                function check() {
                    analyser.getByteFrequencyData(dataArray);
                    let sum = dataArray.reduce((a, b) => a + b, 0);
                    let avg = sum / dataArray.length;

                    if (avg > 55) { // Реакция на дуновение
                        flame.style.display = 'none';
                        hint.innerText = "Пусть всё сбудется ✨";
                        stream.getTracks().forEach(t => t.stop());
                    } else {
                        requestAnimationFrame(check);
                    }
                }
                check();
            } catch (e) {
                hint.innerText = "Микрофон недоступен, просто нажми на огонь";
                flame.onclick = () => { flame.style.display = 'none'; hint.innerText = "Пусть всё сбудется ✨"; };
            }
        }
    </script>
</body>
</html>
