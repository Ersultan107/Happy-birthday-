<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Magic Test</title>
    <style>
        :root {
            --bg: #0f0f0f;
            --gold: #d4a373;
            --cream: #fff5e6;
        }

        body {
            background: var(--bg);
            color: var(--gold);
            margin: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Georgia', serif;
            overflow: hidden;
        }

        /* Эффект кинопленки */
        .grain {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://upload.wikimedia.org/wikipedia/commons/7/76/1k_Grain.jpg');
            opacity: 0.04;
            pointer-events: none;
            z-index: 10;
        }

        #start-btn {
            padding: 20px 40px;
            background: none;
            border: 1px solid var(--gold);
            color: var(--gold);
            letter-spacing: 4px;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.5s;
            z-index: 20;
        }

        /* Контейнер торта */
        #cake-zone {
            display: none;
            flex-direction: column;
            align-items: center;
            animation: fadeIn 2s ease;
        }

        .layer {
            width: 180px; height: 35px;
            background: #e2a99a;
            border-radius: 8px;
            margin: 2px 0;
            box-shadow: inset 0 -5px 15px rgba(0,0,0,0.2);
            opacity: 0;
        }

        .cream-drip {
            width: 190px; height: 12px;
            background: var(--cream);
            border-radius: 20px;
            margin: -6px 0;
            z-index: 2;
            clip-path: inset(0 100% 0 0);
        }

        /* Анимации сборки */
        .show-layer { animation: slideUp 0.8s ease forwards; }
        .show-cream { animation: drip 1.2s ease forwards; }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes drip {
            to { clip-path: inset(0 0 0 0); }
        }

        /* Свеча */
        .candle {
            width: 5px; height: 35px;
            background: linear-gradient(to bottom, #fff, var(--gold));
            position: relative;
            margin-bottom: 5px;
            opacity: 0;
            transition: 1s;
        }

        .flame {
            width: 12px; height: 20px;
            background: radial-gradient(circle at bottom, #fff, #ffcc00, transparent);
            border-radius: 50% 50% 20% 20%;
            position: absolute; top: -22px; left: -4px;
            filter: blur(0.5px);
            box-shadow: 0 0 15px #ffaa00;
            animation: flicker 0.1s infinite alternate;
        }

        @keyframes flicker {
            from { transform: scale(1); } to { transform: scale(1.1) rotate(2deg); }
        }

        #status {
            margin-top: 30px;
            font-style: italic;
            letter-spacing: 1px;
            text-align: center;
            max-width: 80%;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div class="grain"></div>
    <button id="start-btn">Начать просмотр</button>

    <div id="cake-zone">
        <div class="candle" id="candle"><div class="flame" id="flame"></div></div>
        <div class="layer" id="l3"></div>
        <div class="cream-drip" id="c2"></div>
        <div class="layer" id="l2"></div>
        <div class="cream-drip" id="c1"></div>
        <div class="layer" id="l1"></div>
        <p id="status"></p>
    </div>

    <script>
        const startBtn = document.getElementById('start-btn');
        const cakeZone = document.getElementById('cake-zone');
        const status = document.getElementById('status');
        const flame = document.getElementById('flame');

        startBtn.onclick = () => {
            startBtn.style.display = 'none';
            cakeZone.style.display = 'flex';
            assembleCake();
        };

        function assembleCake() {
            const steps = [
                {id: 'l1', class: 'show-layer', d: 500},
                {id: 'c1', class: 'show-cream', d: 1300},
                {id: 'l2', class: 'show-layer', d: 2100},
                {id: 'c2', class: 'show-cream', d: 2900},
                {id: 'l3', class: 'show-layer', d: 3700}
            ];

            steps.forEach(step => {
                setTimeout(() => {
                    document.getElementById(step.id).classList.add(step.class);
                }, step.d);
            });

            setTimeout(() => {
                document.getElementById('candle').style.opacity = '1';
                status.innerText = "Загадай желание и дуй...";
                startListening();
            }, 5000);
        }

        async function startListening() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const analyser = ctx.createAnalyser();
                const src = ctx.createMediaStreamSource(stream);
                src.connect(analyser);
                analyser.fftSize = 256;
                const data = new Uint8Array(analyser.frequencyBinCount);

                function detect() {
                    analyser.getByteFrequencyData(data);
                    let sum = 0;
                    for(let i=0; i<data.length; i++) sum += data[i];
                    let volume = sum / data.length;

                    // Если громкость выше порога (дуновение)
                    if (volume > 45) { 
                        flame.style.display = 'none';
                        status.innerText = "Всё обязательно сбудется ✨";
                        stream.getTracks().forEach(t => t.stop());
                        return;
                    }
                    requestAnimationFrame(detect);
                }
                detect();
            } catch (err) {
                status.innerText = "Микрофон не сработал. Просто коснись огня.";
                flame.onclick = () => {
                    flame.style.display = 'none';
                    status.innerText = "Всё обязательно сбудется ✨";
                };
            }
        }
    </script>
</body>
</html>
