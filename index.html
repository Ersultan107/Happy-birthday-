<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dreamy Film Cake</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <style>
        :root {
            --cake: #362218;
            --cream: #fff9f0;
            --gold: #d4a373;
            --flame: #ff8d00;
        }

        body {
            background: #0a0a0a;
            margin: 0; height: 100vh;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden; font-family: 'Playfair Display', serif;
        }

        /* Эффект кинопленки */
        .film-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 20%, rgba(0,0,0,0.8) 100%);
            pointer-events: none; z-index: 50;
        }

        .grain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: url('https://upload.wikimedia.org/wikipedia/commons/7/76/1k_Grain.jpg');
            opacity: 0.03; pointer-events: none; z-index: 51; mix-blend-mode: overlay;
        }

        #start-btn {
            z-index: 100; padding: 20px 50px; background: none;
            border: 1px solid var(--gold); color: var(--gold);
            letter-spacing: 5px; cursor: pointer; text-transform: uppercase;
            transition: 0.5s; backdrop-filter: blur(5px);
        }

        .stage {
            position: relative; width: 350px; height: 450px;
            display: none; flex-direction: column-reverse; align-items: center;
        }

        /* Объемный торт с текстурой */
        .layer {
            width: 260px; height: 90px;
            background: linear-gradient(180deg, #4e3528 0%, var(--cake) 100%);
            border-radius: 130px / 35px;
            position: relative; margin-bottom: -45px;
            box-shadow: inset 0 -20px 40px rgba(0,0,0,0.8), 0 30px 50px rgba(0,0,0,0.9);
            z-index: 1;
        }

        .layer::before { /* Световой блик сверху */
            content: ''; position: absolute; top: 0; left: 5%; width: 90%; height: 35px;
            background: rgba(255,255,255,0.03); border-radius: 50%;
        }

        .cream {
            width: 270px; height: 45px;
            background: radial-gradient(circle at 50% 0%, #ffffff 0%, #f2e6d9 100%);
            border-radius: 135px / 22px;
            margin-bottom: -35px; z-index: 5;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.5));
        }

        /* Свеча и магический огонь */
        .candle {
            width: 10px; height: 80px;
            background: linear-gradient(to bottom, #fff, var(--gold));
            position: relative; z-index: 10; margin-bottom: 25px;
            border-radius: 2px; box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }

        .flame-core {
            width: 24px; height: 40px; background: var(--flame);
            border-radius: 50% 50% 20% 20%; position: absolute; top: -45px; left: -7px;
            box-shadow: 0 0 40px var(--flame), 0 0 80px #ffea00;
            filter: blur(1px);
        }

        .mic-aura {
            position: absolute; width: 80px; height: 80px;
            border: 1px solid var(--gold); border-radius: 50%;
            top: -65px; left: -35px; opacity: 0; pointer-events: none;
        }

        #hint {
            color: var(--gold); margin-top: 60px; font-style: italic;
            opacity: 0; font-size: 1.1rem; text-align: center;
            text-shadow: 0 0 10px rgba(212,163,115,0.5);
        }
    </style>
</head>
<body>

    <div class="film-overlay"></div>
    <div class="grain"></div>

    <button id="start-btn">Открыть подарок</button>

    <div class="stage" id="stage">
        <div class="layer" id="l1"></div>
        <div class="cream" id="c1"></div>
        <div class="layer" id="l2" style="width: 200px;"></div>
        <div class="cream" id="c2" style="width: 210px;"></div>
        <div class="layer" id="l3" style="width: 140px;"></div>
        
        <div class="candle" id="candle" style="opacity: 0;">
            <div class="mic-aura" id="aura"></div>
            <div class="flame-core" id="flame"></div>
        </div>
    </div>

    <p id="hint">Загадай желание...</p>

    <script>
        const startBtn = document.getElementById('start-btn');
        const stage = document.getElementById('stage');
        const hint = document.getElementById('hint');
        const flame = document.getElementById('flame');
        const aura = document.getElementById('aura');

        startBtn.onclick = () => {
            gsap.to(startBtn, { opacity: 0, duration: 0.5, onComplete: () => {
                startBtn.style.display = 'none';
                stage.style.display = 'flex';
                buildCake();
            }});
        };

        function buildCake() {
            const tl = gsap.timeline();

            // Анимация сборки через GSAP (плавно и мягко)
            tl.fromTo("#l1", {y: -800, opacity: 0}, {y: 0, opacity: 1, duration: 1.5, ease: "bounce.out"})
              .fromTo("#c1", {scale: 0, opacity: 0}, {scale: 1, opacity: 1, duration: 0.8}, "-=0.5")
              .fromTo("#l2", {y: -600, opacity: 0}, {y: 0, opacity: 1, duration: 1.2, ease: "power2.out"}, "-=0.2")
              .fromTo("#c2", {scale: 0, opacity: 0}, {scale: 1, opacity: 1, duration: 0.8}, "-=0.4")
              .fromTo("#l3", {y: -400, opacity: 0}, {y: 0, opacity: 1, duration: 1, ease: "power2.out"}, "-=0.2")
              .to("#candle", {opacity: 1, duration: 1.5, onComplete: startMic});

            gsap.to(hint, {opacity: 1, duration: 2, delay: 5});
        }

        async function startMic() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const ctx = new AudioContext();
                const analyzer = ctx.createAnalyser();
                const source = ctx.createMediaStreamSource(stream);
                source.connect(analyzer);
                
                const data = new Uint8Array(analyzer.frequencyBinCount);

                function loop() {
                    analyzer.getByteFrequencyData(data);
                    let vol = data.reduce((a, b) => a + b) / data.length;

                    // Анимация ауры в такт дыханию
                    gsap.to(aura, { opacity: vol/50, scale: 0.8 + vol/40, duration: 0.1 });

                    // Снизили порог до минимума для комфорта
                    if (vol > 30) { 
                        gsap.to([flame, aura], { opacity: 0, duration: 0.5 });
                        hint.innerText = "Твоё желание обязательно сбудется ✨";
                        stream.getTracks().forEach(t => t.stop());
                        return;
                    }
                    requestAnimationFrame(loop);
                }
                loop();
            } catch (e) {
                hint.innerText = "Коснись свечи...";
                flame.onclick = () => { flame.style.display = 'none'; hint.innerText = "Всё сбудется ✨"; };
            }
        }
    </script>
</body>
</html>
